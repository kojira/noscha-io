name = "noscha-io"
main = "worker-entry.mjs"
compatibility_date = "2024-01-01"
workers_dev = true
routes = [
  { pattern = "noscha.io", custom_domain = true },
  { pattern = "www.noscha.io", custom_domain = true }
]

[build]
command = "cargo install -q worker-build && worker-build --release"

[[r2_buckets]]
binding = "BUCKET"
bucket_name = "noscha-data"

[vars]
DOMAIN = "noscha.io"
# MOCK_PAYMENT is set via `wrangler secret put` (default: false for production)
# MOCK_PAYMENT = "true"  # Uncomment for local dev only

# Secrets (set via `wrangler secret put`):
# COINOS_API_TOKEN
# WEBHOOK_SECRET
# STAGING_AUTH_TOKEN â€” Bearer auth for staging gate (env staging only)
# CF_API_TOKEN
# CF_ZONE_ID

# Email routing - catch-all forwards to this worker
# Note: Email handler is in JS shim (src/email_shim.js) since worker-rs doesn't support email events
# Configure in Cloudflare Dashboard: Email Routing > Catch-all > Send to Worker

[triggers]
crons = ["*/15 * * * *"]

[env.staging]
name = "noscha-io-staging"
routes = [
  { pattern = "staging.noscha.io", custom_domain = true }
]

[env.staging.build]
command = "cargo install -q worker-build && worker-build --release"

[env.staging.vars]
DOMAIN = "staging.noscha.io"
MOCK_PAYMENT = "true"
REQUIRE_AUTH = "true"

[[env.staging.r2_buckets]]
binding = "BUCKET"
bucket_name = "noscha-data-staging"

[env.staging.triggers]
crons = ["*/15 * * * *"]
