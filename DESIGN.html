<h1>noscha.io 設計書</h1>
<h2>1. サービス概要</h2>
<p><strong>noscha.io</strong> は、Lightning Network で即時決済して利用できる使い捨てメールアドレス・サブドメイン・NIP-05認証サービスである。</p>
<h3>コンセプト</h3>
<ul>
<li><strong>KYCなし・匿名</strong>: アカウント登録不要。Lightning 決済のみで利用開始</li>
<li><strong>使い捨て</strong>: 1日〜1年の短期レンタル。期限切れで自動削除</li>
<li><strong>即時</strong>: 決済確認後、数秒でメール転送・サブドメイン・NIP-05 が有効化</li>
<li><strong>安価</strong>: 1日10sats〜。マイクロペイメントで気軽に使える</li>
</ul>
<h3>技術スタック</h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>技術</th>
</tr>
</thead>
<tbody><tr>
<td>アプリケーション</td>
<td>Cloudflare Workers</td>
</tr>
<tr>
<td>ストレージ</td>
<td>Cloudflare R2 (メタデータ JSON)</td>
</tr>
<tr>
<td>メール</td>
<td>Cloudflare Email Routing API</td>
</tr>
<tr>
<td>DNS</td>
<td>Cloudflare DNS API</td>
</tr>
<tr>
<td>決済</td>
<td>Coinos API (Lightning Network)</td>
</tr>
<tr>
<td>フロントエンド</td>
<td>Workers 上の静的HTML (軽量SPA)</td>
</tr>
</tbody></table>
<h3>提供機能</h3>
<ol>
<li><strong>メール転送</strong>: <code>{username}@noscha.io</code> 宛のメールを指定アドレスに転送</li>
<li><strong>サブドメイン</strong>: <code>{username}.noscha.io</code> にCNAME/Aレコードを設定</li>
<li><strong>NIP-05認証</strong>: <code>{username}@noscha.io</code> で Nostr NIP-05 認証を提供</li>
</ol>
<hr>
<h2>2. ユーザーフロー</h2>
<h3>2.1 購入フロー</h3>
<pre><code>ユーザー                    noscha.io Workers              Coinos API
  |                              |                            |
  |  1. POST /api/order          |                            |
  |  (username, plan, options)   |                            |
  |-----------------------------&gt;|                            |
  |                              |  2. POST /api/v2/invoice   |
  |                              |  (amount, webhook)         |
  |                              |---------------------------&gt;|
  |                              |                            |
  |                              |  3. Invoice (bolt11)       |
  |                              |&lt;---------------------------|
  |  4. Invoice返却              |                            |
  |  (order_id, bolt11, qr)      |                            |
  |&lt;-----------------------------|                            |
  |                              |                            |
  |  5. Lightning支払い実行      |                            |
  |  (Wallet -&gt; Coinos)          |                            |
  |------------------------------------------------------------&gt;
  |                              |                            |
  |                              |  6. Webhook: 支払い完了     |
  |                              |&lt;---------------------------|
  |                              |                            |
  |                              |  7. プロビジョニング実行    |
  |                              |  - Email Routing 設定       |
  |                              |  - DNS レコード作成         |
  |                              |  - R2 にデータ保存          |
  |                              |  - NIP-05 キャッシュ更新    |
  |                              |                            |
  |  8. 完了通知                  |                            |
  |  (SSE or ポーリング)          |                            |
  |&lt;-----------------------------|                            |
</code></pre>
<h3>2.2 利用フロー</h3>
<ul>
<li><strong>メール転送</strong>: 外部から <code>alice@noscha.io</code> にメール送信 → Cloudflare Email Routing が Workers を呼び出し → Workers が転送先を R2 から取得 → 転送実行</li>
<li><strong>サブドメイン</strong>: <code>alice.noscha.io</code> にアクセス → DNS レコード (CNAME/A) で設定先に解決</li>
<li><strong>NIP-05</strong>: Nostr クライアントが <code>https://noscha.io/.well-known/nostr.json?name=alice</code> にリクエスト → Workers が R2 から pubkey を取得して応答</li>
</ul>
<h3>2.3 期限切れフロー</h3>
<pre><code>Cron Trigger (毎時)
  |
  |  1. R2 から全アクティブレンタルをスキャン
  |  2. expires_at &lt; now のレコードを抽出
  |  3. 各レコードについて:
  |     - Email Routing ルール削除
  |     - DNS レコード削除
  |     - R2 データを status: &quot;expired&quot; に更新
  |     - NIP-05 キャッシュから除去
</code></pre>
<h3>2.4 延長フロー</h3>
<ul>
<li>期限切れ前に <code>POST /api/renew</code> で同一 username の延長が可能</li>
<li>新規購入と同様の決済フロー。決済完了後 <code>expires_at</code> を延長</li>
</ul>
<hr>
<h2>3. API 設計</h2>
<h3>3.1 公開 API</h3>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>パス</th>
<th>説明</th>
</tr>
</thead>
<tbody><tr>
<td><code>GET</code></td>
<td><code>/api/check/{username}</code></td>
<td>username の利用可否を確認</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/api/order</code></td>
<td>新規注文を作成し Invoice を返却</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/api/order/{order_id}/status</code></td>
<td>注文ステータス確認 (SSE対応)</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/api/renew</code></td>
<td>既存レンタルの延長注文</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/api/rental/{username}</code></td>
<td>レンタル情報参照 (管理トークン必須)</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/.well-known/nostr.json</code></td>
<td>NIP-05 認証エンドポイント</td>
</tr>
</tbody></table>
<h3>3.2 内部 API (Webhook)</h3>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>パス</th>
<th>説明</th>
</tr>
</thead>
<tbody><tr>
<td><code>POST</code></td>
<td><code>/api/webhook/coinos</code></td>
<td>Coinos 決済完了 Webhook</td>
</tr>
</tbody></table>
<h3>3.3 エンドポイント詳細</h3>
<h4><code>GET /api/check/{username}</code></h4>
<p><strong>レスポンス:</strong></p>
<pre><code class="language-json">{
  &quot;available&quot;: true,
  &quot;username&quot;: &quot;alice&quot;
}
</code></pre>
<p>ユーザー名のバリデーションルール:</p>
<ul>
<li>3〜20文字</li>
<li>英小文字、数字、ハイフンのみ</li>
<li>ハイフンは先頭・末尾不可</li>
<li>予約語リスト (<code>admin</code>, <code>www</code>, <code>mail</code>, <code>api</code>, <code>ns1</code>, <code>ns2</code>, <code>_dmarc</code>, <code>autoconfig</code> 等) は使用不可</li>
</ul>
<h4><code>POST /api/order</code></h4>
<p><strong>リクエスト:</strong></p>
<pre><code class="language-json">{
  &quot;username&quot;: &quot;alice&quot;,
  &quot;plan&quot;: &quot;30d&quot;,
  &quot;services&quot;: {
    &quot;email&quot;: {
      &quot;forward_to&quot;: &quot;realaddress@example.com&quot;
    },
    &quot;subdomain&quot;: {
      &quot;type&quot;: &quot;CNAME&quot;,
      &quot;target&quot;: &quot;mysite.example.com&quot;
    },
    &quot;nip05&quot;: {
      &quot;pubkey&quot;: &quot;npub1...&quot;
    }
  }
}
</code></pre>
<p><strong>レスポンス:</strong></p>
<pre><code class="language-json">{
  &quot;order_id&quot;: &quot;ord_xxxxxxxx&quot;,
  &quot;amount_sats&quot;: 100,
  &quot;bolt11&quot;: &quot;lnbc...&quot;,
  &quot;expires_at&quot;: &quot;2025-01-15T12:00:00Z&quot;,
  &quot;management_token&quot;: &quot;mgmt_xxxxxxxx&quot;
}
</code></pre>
<p><code>management_token</code> は注文時に一度だけ返却される。レンタル情報の参照・延長に使用。</p>
<h4><code>POST /api/renew</code></h4>
<p><strong>リクエスト:</strong></p>
<pre><code class="language-json">{
  &quot;username&quot;: &quot;alice&quot;,
  &quot;management_token&quot;: &quot;mgmt_xxxxxxxx&quot;,
  &quot;plan&quot;: &quot;30d&quot;
}
</code></pre>
<h4><code>GET /api/order/{order_id}/status</code></h4>
<p>SSE (Server-Sent Events) 対応。ポーリングも可。</p>
<pre><code class="language-json">{
  &quot;order_id&quot;: &quot;ord_xxxxxxxx&quot;,
  &quot;status&quot;: &quot;paid&quot;,
  &quot;provisioning&quot;: &quot;completed&quot;,
  &quot;rental&quot;: {
    &quot;username&quot;: &quot;alice&quot;,
    &quot;expires_at&quot;: &quot;2025-02-14T12:00:00Z&quot;,
    &quot;services&quot;: [&quot;email&quot;, &quot;subdomain&quot;, &quot;nip05&quot;]
  }
}
</code></pre>
<p>ステータス遷移: <code>pending</code> → <code>paid</code> → <code>provisioning</code> → <code>completed</code> / <code>failed</code></p>
<h4><code>GET /.well-known/nostr.json?name={username}</code></h4>
<p><strong>レスポンス (NIP-05):</strong></p>
<pre><code class="language-json">{
  &quot;names&quot;: {
    &quot;alice&quot;: &quot;hex_pubkey_here&quot;
  },
  &quot;relays&quot;: {
    &quot;hex_pubkey_here&quot;: [&quot;wss://relay.example.com&quot;]
  }
}
</code></pre>
<hr>
<h2>4. データモデル (R2)</h2>
<p>R2 はオブジェクトストレージのため、キー設計が重要。以下のプレフィックスベースの構造を採用する。</p>
<h3>4.1 キー構造</h3>
<pre><code>rentals/{username}.json          -- アクティブレンタル情報
orders/{order_id}.json           -- 注文情報
indices/by-expiry/{ISO日付}/{username}  -- 有効期限インデックス (空ボディ)
cache/nostr.json                 -- NIP-05 全ユーザーキャッシュ
</code></pre>
<h3>4.2 レンタルオブジェクト</h3>
<p><strong>キー:</strong> <code>rentals/{username}.json</code></p>
<pre><code class="language-json">{
  &quot;username&quot;: &quot;alice&quot;,
  &quot;status&quot;: &quot;active&quot;,
  &quot;management_token_hash&quot;: &quot;sha256:xxxxxxxx&quot;,
  &quot;created_at&quot;: &quot;2025-01-15T12:00:00Z&quot;,
  &quot;expires_at&quot;: &quot;2025-02-14T12:00:00Z&quot;,
  &quot;plan&quot;: &quot;30d&quot;,
  &quot;services&quot;: {
    &quot;email&quot;: {
      &quot;enabled&quot;: true,
      &quot;forward_to&quot;: &quot;realaddress@example.com&quot;,
      &quot;cf_rule_id&quot;: &quot;rule_xxxxxxxx&quot;
    },
    &quot;subdomain&quot;: {
      &quot;enabled&quot;: true,
      &quot;type&quot;: &quot;CNAME&quot;,
      &quot;target&quot;: &quot;mysite.example.com&quot;,
      &quot;cf_record_id&quot;: &quot;rec_xxxxxxxx&quot;
    },
    &quot;nip05&quot;: {
      &quot;enabled&quot;: true,
      &quot;pubkey_hex&quot;: &quot;abcdef1234567890...&quot;,
      &quot;relays&quot;: [&quot;wss://relay.damus.io&quot;]
    }
  },
  &quot;payment_history&quot;: [
    {
      &quot;order_id&quot;: &quot;ord_xxxxxxxx&quot;,
      &quot;amount_sats&quot;: 100,
      &quot;paid_at&quot;: &quot;2025-01-15T12:00:05Z&quot;
    }
  ]
}
</code></pre>
<h3>4.3 注文オブジェクト</h3>
<p><strong>キー:</strong> <code>orders/{order_id}.json</code></p>
<pre><code class="language-json">{
  &quot;order_id&quot;: &quot;ord_xxxxxxxx&quot;,
  &quot;username&quot;: &quot;alice&quot;,
  &quot;type&quot;: &quot;new&quot;,
  &quot;plan&quot;: &quot;30d&quot;,
  &quot;amount_sats&quot;: 100,
  &quot;status&quot;: &quot;completed&quot;,
  &quot;bolt11&quot;: &quot;lnbc...&quot;,
  &quot;coinos_invoice_id&quot;: &quot;inv_xxx&quot;,
  &quot;created_at&quot;: &quot;2025-01-15T12:00:00Z&quot;,
  &quot;paid_at&quot;: &quot;2025-01-15T12:00:05Z&quot;,
  &quot;provisioned_at&quot;: &quot;2025-01-15T12:00:06Z&quot;,
  &quot;services_requested&quot;: {
    &quot;email&quot;: { &quot;forward_to&quot;: &quot;realaddress@example.com&quot; },
    &quot;subdomain&quot;: { &quot;type&quot;: &quot;CNAME&quot;, &quot;target&quot;: &quot;mysite.example.com&quot; },
    &quot;nip05&quot;: { &quot;pubkey&quot;: &quot;npub1...&quot; }
  }
}
</code></pre>
<h3>4.4 有効期限インデックス</h3>
<p>Cron による期限切れ処理を効率化するため、日付別のインデックスを作成する。</p>
<p><strong>キー:</strong> <code>indices/by-expiry/2025-02-14/alice</code>
<strong>ボディ:</strong> 空 (キーの存在だけで十分)</p>
<p>Cron は当日以前の日付プレフィックスを <code>list()</code> し、該当レンタルを処理する。</p>
<h3>4.5 NIP-05 キャッシュ</h3>
<p><strong>キー:</strong> <code>cache/nostr.json</code></p>
<p>全アクティブユーザーの NIP-05 情報を結合したキャッシュ。<code>/.well-known/nostr.json</code> へのリクエスト時に R2 から1回の読み取りで応答できる。</p>
<pre><code class="language-json">{
  &quot;names&quot;: {
    &quot;alice&quot;: &quot;abcdef1234567890...&quot;,
    &quot;bob&quot;: &quot;1234567890abcdef...&quot;
  },
  &quot;relays&quot;: {
    &quot;abcdef1234567890...&quot;: [&quot;wss://relay.damus.io&quot;],
    &quot;1234567890abcdef...&quot;: [&quot;wss://relay.nostr.band&quot;]
  }
}
</code></pre>
<p>プロビジョニング・期限切れ処理時に差分更新する。</p>
<hr>
<h2>5. Cloudflare Workers 構成</h2>
<h3>5.1 Worker 一覧</h3>
<p>単一の Worker で全機能を提供する (モノリス構成)。ルーティングは <code>itty-router</code> 等で実装。</p>
<pre><code>noscha-worker
├── routes/
│   ├── api.ts          -- /api/* ハンドラ
│   ├── wellknown.ts    -- /.well-known/* ハンドラ
│   └── static.ts       -- / フロントエンド配信
├── services/
│   ├── coinos.ts       -- Coinos API クライアント
│   ├── email.ts        -- Cloudflare Email Routing API
│   ├── dns.ts          -- Cloudflare DNS API
│   ├── provisioner.ts  -- プロビジョニングオーケストレーター
│   └── cleanup.ts      -- 期限切れ処理
├── models/
│   ├── rental.ts       -- レンタルモデル
│   └── order.ts        -- 注文モデル
├── email-worker.ts     -- Email Worker (メール受信ハンドラ)
└── index.ts            -- エントリポイント
</code></pre>
<h3>5.2 Bindings</h3>
<pre><code class="language-toml"># wrangler.toml
name = &quot;noscha-worker&quot;
compatibility_date = &quot;2024-01-01&quot;

[[r2_buckets]]
binding = &quot;BUCKET&quot;
bucket_name = &quot;noscha-data&quot;

[vars]
COINOS_API_URL = &quot;https://coinos.io/api&quot;
CF_ZONE_ID = &quot;xxxxxxxx&quot;
DOMAIN = &quot;noscha.io&quot;

# Secrets (wrangler secret put で設定)
# COINOS_API_TOKEN
# CF_API_TOKEN
# WEBHOOK_SECRET
# MANAGEMENT_TOKEN_SALT
</code></pre>
<h3>5.3 Routes</h3>
<pre><code>noscha.io/*              → noscha-worker (HTTP)
noscha.io (Email)        → noscha-worker (Email Worker)
</code></pre>
<h3>5.4 Cron Triggers</h3>
<pre><code class="language-toml">[triggers]
crons = [&quot;0 * * * *&quot;]   # 毎時0分に実行
</code></pre>
<p>Cron ハンドラの処理:</p>
<ol>
<li><code>indices/by-expiry/</code> から期限切れエントリを検索</li>
<li>該当レンタルのクリーンアップ実行</li>
<li>R2 ステータス更新、インデックス削除</li>
</ol>
<h3>5.5 Email Worker</h3>
<p>Cloudflare Email Routing の Email Worker として設定。受信メールを処理する。</p>
<pre><code class="language-typescript">export default {
  async email(message: EmailMessage, env: Env) {
    // 1. To アドレスから username を抽出
    // 2. R2 から rental を取得
    // 3. status === &quot;active&quot; かつ email.enabled を確認
    // 4. forward_to にメール転送
    // 5. 該当なしの場合は reject
  }
}
</code></pre>
<hr>
<h2>6. Coinos API 連携</h2>
<h3>6.1 Coinos API 概要</h3>
<p>Coinos (coinos.io) は Lightning Network の決済プラットフォーム。API を通じて Invoice の発行と支払い確認ができる。</p>
<h3>6.2 認証</h3>
<pre><code>Authorization: Bearer {COINOS_API_TOKEN}
</code></pre>
<p>API トークンは Coinos ダッシュボードから取得し、Workers の Secret に保存。</p>
<h3>6.3 Invoice 発行</h3>
<p><strong>エンドポイント:</strong> <code>POST https://coinos.io/api/invoice</code></p>
<pre><code class="language-json">{
  &quot;invoice&quot;: {
    &quot;amount&quot;: 100,
    &quot;type&quot;: &quot;lightning&quot;,
    &quot;webhook&quot;: &quot;https://noscha.io/api/webhook/coinos&quot;,
    &quot;secret&quot;: &quot;order_secret_xxx&quot;
  }
}
</code></pre>
<p><strong>レスポンス:</strong></p>
<pre><code class="language-json">{
  &quot;id&quot;: &quot;invoice_id&quot;,
  &quot;amount&quot;: 100,
  &quot;text&quot;: &quot;lnbc1u1p...&quot;,
  &quot;hash&quot;: &quot;payment_hash_xxx&quot;
}
</code></pre>
<h3>6.4 支払い確認</h3>
<p>2つの方式を併用する:</p>
<h4>Webhook (プライマリ)</h4>
<p>Coinos が支払い完了時に <code>webhook</code> URL に POST する。</p>
<pre><code class="language-json">{
  &quot;id&quot;: &quot;invoice_id&quot;,
  &quot;amount&quot;: 100,
  &quot;hash&quot;: &quot;payment_hash_xxx&quot;,
  &quot;confirmed&quot;: true
}
</code></pre>
<p>Webhook の検証:</p>
<ul>
<li><code>secret</code> フィールドと注文時に設定した <code>secret</code> を照合</li>
<li>リクエスト元の IP を確認 (可能な場合)</li>
</ul>
<h4>ポーリング (フォールバック)</h4>
<p>Webhook が到達しない場合のフォールバック。フロントエンドからの <code>GET /api/order/{order_id}/status</code> リクエスト時に、未確認の注文があれば Coinos API に問い合わせる。</p>
<p><strong>エンドポイント:</strong> <code>GET https://coinos.io/api/invoice/{invoice_id}</code></p>
<h3>6.5 Invoice 有効期限</h3>
<p>Coinos Invoice のデフォルト有効期限に加え、noscha.io 側でも15分の有効期限を設定。期限切れの注文は <code>expired</code> ステータスに更新し、username のロックを解放する。</p>
<h3>6.6 金額計算</h3>
<pre><code class="language-typescript">function calculateAmount(plan: string, services: string[]): number {
  const basePrices: Record&lt;string, number&gt; = {
    &quot;1d&quot;: 10,
    &quot;7d&quot;: 50,
    &quot;30d&quot;: 100,
    &quot;90d&quot;: 250,
    &quot;180d&quot;: 450,
    &quot;365d&quot;: 800,
  };
  // 全サービスバンドル価格 (email + subdomain + nip05)
  return basePrices[plan];
}
</code></pre>
<hr>
<h2>7. Cloudflare Email Routing API 連携</h2>
<h3>7.1 概要</h3>
<p>Cloudflare Email Routing を使用して、<code>{username}@noscha.io</code> 宛のメールを転送する。2つの方式がある:</p>
<ul>
<li><strong>Routing Rules (catch-all + Email Worker)</strong>: 全メールを Email Worker で受信し、プログラムで転送先を判定</li>
<li><strong>Destination Addresses API</strong>: 個別の転送ルールを API で管理</li>
</ul>
<p><strong>採用方式: Email Worker (catch-all)</strong></p>
<p>理由: Routing Rules API は転送先メールアドレスの事前検証 (確認メール送信) が必要であり、匿名サービスの性質と合わない。Email Worker なら <code>message.forward()</code> で任意のアドレスに転送可能。</p>
<h3>7.2 Email Worker での転送処理</h3>
<pre><code class="language-typescript">async email(message: EmailMessage, env: Env) {
  const recipient = message.to;  // alice@noscha.io
  const username = recipient.split(&quot;@&quot;)[0].toLowerCase();

  // R2 からレンタル情報を取得
  const rental = await getRental(env.BUCKET, username);

  if (!rental || rental.status !== &quot;active&quot; || !rental.services.email?.enabled) {
    message.setReject(&quot;Address not found&quot;);
    return;
  }

  // 転送実行
  await message.forward(rental.services.email.forward_to);
}
</code></pre>
<h3>7.3 設定手順</h3>
<ol>
<li>Cloudflare Dashboard で <code>noscha.io</code> の Email Routing を有効化</li>
<li>Catch-all ルールを Email Worker に設定</li>
<li>DNS に MX レコードが自動追加される</li>
</ol>
<h3>7.4 制限事項</h3>
<ul>
<li>Cloudflare Email Routing は受信のみ。送信はサポートしない</li>
<li>添付ファイルサイズ上限: 25MB (Cloudflare の制限)</li>
<li><code>message.forward()</code> は1回のみ呼び出し可能 (複数転送先は非対応)</li>
</ul>
<hr>
<h2>8. Cloudflare DNS API 連携</h2>
<h3>8.1 概要</h3>
<p>サブドメイン機能として <code>{username}.noscha.io</code> の DNS レコードを API で動的に管理する。</p>
<h3>8.2 API 認証</h3>
<pre><code>Authorization: Bearer {CF_API_TOKEN}
</code></pre>
<p>必要な権限: <code>Zone.DNS:Edit</code> (対象ゾーン: noscha.io)</p>
<h3>8.3 レコード作成</h3>
<p><strong>エンドポイント:</strong> <code>POST https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records</code></p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;CNAME&quot;,
  &quot;name&quot;: &quot;alice.noscha.io&quot;,
  &quot;content&quot;: &quot;mysite.example.com&quot;,
  &quot;ttl&quot;: 300,
  &quot;proxied&quot;: false,
  &quot;comment&quot;: &quot;noscha rental: alice, expires: 2025-02-14&quot;
}
</code></pre>
<p>サポートするレコードタイプ:</p>
<ul>
<li><code>CNAME</code>: 他ドメインへのエイリアス</li>
<li><code>A</code>: IPv4 アドレス</li>
<li><code>AAAA</code>: IPv6 アドレス</li>
</ul>
<h3>8.4 レコード削除</h3>
<p><strong>エンドポイント:</strong> <code>DELETE https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records/{record_id}</code></p>
<p>期限切れ処理時に呼び出す。<code>cf_record_id</code> はレンタルオブジェクトに保存済み。</p>
<h3>8.5 レコード更新</h3>
<p>延長時にレコード内容を変更する場合:</p>
<p><strong>エンドポイント:</strong> <code>PATCH https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records/{record_id}</code></p>
<h3>8.6 Proxy 設定</h3>
<ul>
<li>デフォルト: <code>proxied: false</code> (DNS only)</li>
<li>ユーザーが HTTPS を必要とする場合に <code>proxied: true</code> を選択可能 (Cloudflare Proxy 経由)</li>
<li>Proxy 有効時は Cloudflare の SSL が自動適用される</li>
</ul>
<h3>8.7 制限事項</h3>
<ul>
<li>Cloudflare Free プランの DNS レコード数上限: 1000件/ゾーン</li>
<li>大規模運用時は上位プランまたは複数ゾーンへの分散が必要</li>
<li>DNS 伝播に最大5分 (TTL 300秒)</li>
</ul>
<hr>
<h2>9. NIP-05 実装</h2>
<h3>9.1 NIP-05 仕様</h3>
<p>NIP-05 は Nostr Identity Document の仕様。<code>name@domain</code> 形式の識別子を Nostr 公開鍵に紐づける。</p>
<p>クライアントは以下の URL にアクセスして検証する:</p>
<pre><code>GET https://{domain}/.well-known/nostr.json?name={name}
</code></pre>
<h3>9.2 レスポンス形式</h3>
<pre><code class="language-json">{
  &quot;names&quot;: {
    &quot;alice&quot;: &quot;abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890&quot;
  },
  &quot;relays&quot;: {
    &quot;abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890&quot;: [
      &quot;wss://relay.damus.io&quot;,
      &quot;wss://relay.nostr.band&quot;
    ]
  }
}
</code></pre>
<h3>9.3 実装方式</h3>
<pre><code class="language-typescript">// /.well-known/nostr.json ハンドラ
async function handleNip05(request: Request, env: Env): Promise&lt;Response&gt; {
  const url = new URL(request.url);
  const name = url.searchParams.get(&quot;name&quot;)?.toLowerCase();

  if (!name) {
    // 全ユーザーを返す (キャッシュから)
    const cache = await env.BUCKET.get(&quot;cache/nostr.json&quot;);
    if (!cache) return new Response(&quot;{}&quot;, { headers: corsHeaders });
    return new Response(cache.body, {
      headers: {
        ...corsHeaders,
        &quot;Content-Type&quot;: &quot;application/json&quot;,
        &quot;Cache-Control&quot;: &quot;max-age=300&quot;,
        &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;
      }
    });
  }

  // 個別ユーザー取得
  const rental = await env.BUCKET.get(`rentals/${name}.json`);
  if (!rental) return new Response(&#39;{&quot;names&quot;:{},&quot;relays&quot;:{}}&#39;, { headers: corsHeaders });

  const data = await rental.json();
  if (data.status !== &quot;active&quot; || !data.services.nip05?.enabled) {
    return new Response(&#39;{&quot;names&quot;:{},&quot;relays&quot;:{}}&#39;, { headers: corsHeaders });
  }

  const response = {
    names: { [name]: data.services.nip05.pubkey_hex },
    relays: { [data.services.nip05.pubkey_hex]: data.services.nip05.relays || [] }
  };

  return new Response(JSON.stringify(response), {
    headers: {
      &quot;Content-Type&quot;: &quot;application/json&quot;,
      &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
      &quot;Cache-Control&quot;: &quot;max-age=300&quot;
    }
  });
}
</code></pre>
<h3>9.4 CORS ヘッダー</h3>
<p>NIP-05 仕様では CORS が必須:</p>
<pre><code>Access-Control-Allow-Origin: *
</code></pre>
<h3>9.5 pubkey 形式の変換</h3>
<p>ユーザーは <code>npub1...</code> (bech32) 形式で入力するが、NIP-05 レスポンスでは hex 形式が必要。Workers 側で bech32 → hex 変換を行う。</p>
<hr>
<h2>10. セキュリティ考慮</h2>
<h3>10.1 レート制限</h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>制限</th>
<th>実装</th>
</tr>
</thead>
<tbody><tr>
<td><code>POST /api/order</code></td>
<td>10回/分/IP</td>
<td>Cloudflare Rate Limiting Rule</td>
</tr>
<tr>
<td><code>GET /api/check/*</code></td>
<td>30回/分/IP</td>
<td>Cloudflare Rate Limiting Rule</td>
</tr>
<tr>
<td><code>POST /api/webhook/*</code></td>
<td>100回/分 (全体)</td>
<td>Worker 内カウンター</td>
</tr>
<tr>
<td><code>GET /.well-known/nostr.json</code></td>
<td>60回/分/IP</td>
<td>Cloudflare Rate Limiting Rule</td>
</tr>
</tbody></table>
<h3>10.2 不正利用対策</h3>
<h4>username スクワッティング防止</h4>
<ul>
<li>未決済の注文は15分で有効期限切れ → username ロック解放</li>
<li>同一 IP からの同時未決済注文数を制限 (最大3件)</li>
</ul>
<h4>スパム・フィッシング対策</h4>
<ul>
<li>禁止 username リスト (有名ブランド名、紛らわしい名前)</li>
<li>メール転送は受信のみ (送信不可のため、なりすまし送信は不可)</li>
<li>不正利用報告フォーム (<code>/abuse</code>) の設置</li>
<li>報告されたアカウントの手動レビュー・即時停止機能</li>
</ul>
<h4>Webhook セキュリティ</h4>
<ul>
<li>Coinos Webhook の <code>secret</code> フィールドによる検証</li>
<li>Webhook エンドポイントはべき等 (同一 payment の二重処理防止)</li>
</ul>
<h4>management_token セキュリティ</h4>
<ul>
<li>トークンは SHA-256 ハッシュ化して R2 に保存 (平文保存しない)</li>
<li>ソルト付きハッシュ (<code>MANAGEMENT_TOKEN_SALT</code> を使用)</li>
<li>トークンは注文完了時に一度だけ返却。再発行不可</li>
</ul>
<h4>DNS 悪用防止</h4>
<ul>
<li>CNAME/A レコードのターゲットを検証 (内部 IP レンジへの設定を禁止)</li>
<li><code>127.0.0.0/8</code>, <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code> 等を拒否</li>
</ul>
<h3>10.3 データ保護</h3>
<ul>
<li>R2 のデータは Cloudflare のインフラ上で暗号化 (at-rest)</li>
<li>転送先メールアドレスは平文保存 (機能上必要) だが、期限切れ後は削除</li>
<li>アクセスログは Cloudflare Workers のデフォルトログのみ (最小限)</li>
</ul>
<hr>
<h2>11. 利用規約 (ToS) 要点</h2>
<h3>11.1 サービス内容</h3>
<ul>
<li>noscha.io はメール転送・サブドメイン・NIP-05認証の短期レンタルサービスである</li>
<li>サービスは「現状有姿 (as-is)」で提供され、可用性の保証はない</li>
</ul>
<h3>11.2 禁止事項</h3>
<ul>
<li>スパムメールの送受信に使用すること</li>
<li>フィッシング・詐欺行為の助長</li>
<li>マルウェア配布サイトへのサブドメイン設定</li>
<li>児童搾取に関するコンテンツ</li>
<li>法律に違反する目的での使用</li>
<li>他者の商標・ブランドを騙る username の取得</li>
</ul>
<h3>11.3 サービス停止</h3>
<ul>
<li>禁止事項に該当する場合、事前通知なくサービスを停止できる</li>
<li>停止された場合の返金は行わない</li>
</ul>
<h3>11.4 返金ポリシー</h3>
<ul>
<li>Lightning 決済の性質上、原則として返金不可</li>
<li>サービス側の障害で正常にプロビジョニングされなかった場合は、同等プランの無料再発行で対応</li>
</ul>
<h3>11.5 プライバシー</h3>
<ul>
<li>必要最小限のデータのみ保持 (転送先アドレス、DNS ターゲット、Nostr pubkey)</li>
<li>期限切れ後、データは削除される (ログは一定期間保持)</li>
<li>第三者へのデータ提供は法的要求がない限り行わない</li>
<li>ユーザー識別情報 (アカウント、メールアドレス等) の登録は不要</li>
</ul>
<h3>11.6 免責</h3>
<ul>
<li>メール転送の遅延・不達について責任を負わない</li>
<li>DNS 伝播の遅延について責任を負わない</li>
<li>Cloudflare / Coinos のサービス障害に起因する問題について責任を負わない</li>
</ul>
<hr>
<h2>12. 価格テーブル</h2>
<p>全サービス (メール転送 + サブドメイン + NIP-05) のバンドル価格。</p>
<table>
<thead>
<tr>
<th>プラン</th>
<th>期間</th>
<th>価格 (sats)</th>
<th>日額換算</th>
</tr>
</thead>
<tbody><tr>
<td><code>1d</code></td>
<td>1日</td>
<td>10</td>
<td>10 sats/日</td>
</tr>
<tr>
<td><code>7d</code></td>
<td>7日</td>
<td>50</td>
<td>~7.1 sats/日</td>
</tr>
<tr>
<td><code>30d</code></td>
<td>30日</td>
<td>100</td>
<td>~3.3 sats/日</td>
</tr>
<tr>
<td><code>90d</code></td>
<td>90日</td>
<td>250</td>
<td>~2.8 sats/日</td>
</tr>
<tr>
<td><code>180d</code></td>
<td>180日</td>
<td>450</td>
<td>2.5 sats/日</td>
</tr>
<tr>
<td><code>365d</code></td>
<td>365日</td>
<td>800</td>
<td>~2.2 sats/日</td>
</tr>
</tbody></table>
<h3>個別サービス価格 (将来の拡張)</h3>
<p>初期リリースでは全サービスバンドルのみ。将来的に個別選択を検討:</p>
<table>
<thead>
<tr>
<th>サービス</th>
<th>30日価格 (sats)</th>
</tr>
</thead>
<tbody><tr>
<td>メール転送のみ</td>
<td>50</td>
</tr>
<tr>
<td>サブドメインのみ</td>
<td>50</td>
</tr>
<tr>
<td>NIP-05のみ</td>
<td>30</td>
</tr>
<tr>
<td>全サービスバンドル</td>
<td>100</td>
</tr>
</tbody></table>
<hr>
<h2>13. 将来の拡張案</h2>
<h3>13.1 Lightning Address 転送</h3>
<p><code>alice@noscha.io</code> を Lightning Address として機能させ、受信した支払いをユーザー指定の Lightning Address に転送する。</p>
<p><strong>実装方式:</strong></p>
<ul>
<li><code>/.well-known/lnurlp/{username}</code> エンドポイントを追加</li>
<li>LNURL-pay プロトコルに対応</li>
<li>ユーザー指定の Lightning Address の LNURL を取得し、プロキシとして応答</li>
<li>Invoice は転送先の LNURL から取得して返却 (noscha.io は資金を預からない)</li>
</ul>
<h3>13.2 Nostr Relay プロキシ</h3>
<p><code>wss://noscha.io/{username}</code> として Nostr Relay プロキシを提供。Cloudflare Workers の WebSocket 対応で実装可能。</p>
<h3>13.3 カスタムドメイン対応</h3>
<p>ユーザーが自分のドメインを持ち込み、noscha.io のインフラでメール転送・NIP-05 を利用する。</p>
<h3>13.4 Wildcard サブドメイン</h3>
<p><code>*.alice.noscha.io</code> のようなワイルドカードサブドメインを上位プランとして提供。</p>
<h3>13.5 API キー発行</h3>
<p>開発者向けに API キーを発行し、プログラムからレンタルの管理・一括作成を可能にする。</p>
<h3>13.6 Tor / I2P 対応</h3>
<p><code>.onion</code> アドレスでのアクセスに対応。Cloudflare の Onion Routing 機能を活用。</p>
<h3>13.7 Web UI の強化</h3>
<ul>
<li>レンタル管理ダッシュボード (management_token でログイン)</li>
<li>メール受信履歴の閲覧 (R2 に一時保存)</li>
<li>DNS レコードの変更 UI</li>
</ul>
<h3>13.8 マルチドメイン展開</h3>
<p><code>noscha.io</code> 以外のドメインでも同一インフラでサービスを提供。ユーザーが好みのドメインを選択できる。</p>
<h3>13.9 Zap 統合</h3>
<p>NIP-57 (Zaps) に対応。<code>alice@noscha.io</code> への Zap を転送先 Lightning Address にルーティングする。</p>
<h3>13.10 リファラルプログラム</h3>
<p>既存ユーザーの紹介で新規ユーザーが割引を受けられるプログラム。Lightning で紹介報酬を即時支払い。</p>
