<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>noscha.io — Admin Dashboard</title>
<meta name="description" content="noscha.io Admin Dashboard - Manage Lightning-powered identity services.">
<meta property="og:title" content="noscha.io — Admin Dashboard">
<meta property="og:description" content="Admin panel for noscha.io Lightning-powered identity services.">
<meta property="og:image" content="https://noscha.io/og-image.png">
<meta property="og:url" content="https://noscha.io/admin">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="noscha.io — Admin Dashboard">
<meta name="twitter:description" content="Admin panel for noscha.io Lightning-powered identity services.">
<meta name="twitter:image" content="https://noscha.io/og-image.png">
<link rel="icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/favicon.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d0d0d;--surface:#1a1a1a;--border:#2a2a2a;--text:#e0e0e0;--muted:#888;--purple:#8b5cf6;--purple-dim:#6d28d9;--orange:#f97316;--orange-dim:#c2410c;--green:#22c55e;--red:#ef4444;--yellow:#eab308}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
a{color:var(--purple);text-decoration:none}
.container{max-width:960px;margin:0 auto;padding:2rem 1.5rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
.logo{font-size:1.5rem;font-weight:700}
.logo span:first-child{color:var(--purple)}
.logo span:nth-child(2){color:var(--orange)}
.logo span:last-child{color:var(--muted);font-size:.9rem;font-weight:400;margin-left:.5rem}
.logout-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:.4rem .8rem;border-radius:6px;cursor:pointer;font-size:.8rem}
.logout-btn:hover{border-color:var(--red);color:var(--red)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-bottom:1.5rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1rem;text-align:center}
.stat-val{font-size:1.5rem;font-weight:700;color:var(--purple)}
.stat-val.warn{color:var(--yellow)}
.stat-val.revenue{color:var(--orange)}
.stat-label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-top:.25rem}
.section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.section h2{font-size:1.1rem;margin-bottom:1rem;color:var(--text)}
.toolbar{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center}
.filter-btn{padding:.4rem .8rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--muted);cursor:pointer;font-size:.8rem;transition:all .2s}
.filter-btn:hover{border-color:var(--purple);color:var(--text)}
.filter-btn.active{border-color:var(--purple);background:var(--purple-dim);color:#fff}
.toolbar-spacer{flex:1}
.page-info{font-size:.8rem;color:var(--muted)}
.page-btn{padding:.3rem .6rem;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--muted);cursor:pointer;font-size:.8rem}
.page-btn:hover{border-color:var(--purple)}
.page-btn:disabled{opacity:.3;cursor:not-allowed}
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;padding:.5rem .5rem;border-bottom:2px solid var(--border);color:var(--muted);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
td{padding:.5rem .5rem;border-bottom:1px solid var(--border);white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(139,92,246,.05)}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:12px;font-size:.75rem;font-weight:600}
.badge-active{background:#22c55e22;color:var(--green)}
.badge-expired{background:#88888822;color:var(--muted)}
.badge-banned{background:#ef444422;color:var(--red)}
.badge-warn{background:#eab30822;color:var(--yellow)}
.svc-pill{display:inline-block;padding:.1rem .35rem;border-radius:4px;font-size:.65rem;margin-right:.2rem;background:var(--bg);border:1px solid var(--border);color:var(--muted)}
.svc-pill.on{border-color:var(--purple);color:var(--purple)}
.act-btn{padding:.25rem .5rem;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--muted);cursor:pointer;font-size:.7rem;margin-right:.25rem;transition:all .15s}
.act-btn:hover{border-color:var(--purple);color:var(--text)}
.act-ban{color:var(--red);border-color:rgba(239,68,68,.3)}
.act-ban:hover{border-color:var(--red);background:rgba(239,68,68,.1)}
.act-unban{color:var(--green);border-color:rgba(34,197,94,.3)}
.act-unban:hover{border-color:var(--green);background:rgba(34,197,94,.1)}
.act-extend{color:var(--orange);border-color:rgba(249,115,22,.3)}
.act-extend:hover{border-color:var(--orange);background:rgba(249,115,22,.1)}
.act-revoke{color:var(--red);border-color:rgba(239,68,68,.3)}
.act-revoke:hover{border-color:var(--red);background:rgba(239,68,68,.1)}
#login-screen{max-width:360px;margin:15vh auto}
#login-screen .logo{font-size:2rem;text-align:center;margin-bottom:.5rem}
#login-screen .sub{text-align:center;color:var(--muted);font-size:.9rem;margin-bottom:2rem}
.btn{display:block;width:100%;padding:.75rem;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--purple),var(--orange));color:#fff}
.btn-primary:hover{opacity:.9}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.login-err{color:var(--red);font-size:.8rem;margin-top:.5rem;text-align:center;min-height:1.2em}
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;font-size:.85rem;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
.toast.ok{border-color:var(--green);color:var(--green)}
.toast.err{border-color:var(--red);color:var(--red)}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:340px;max-width:90vw}
.modal h3{font-size:1rem;margin-bottom:1rem}
.modal-actions{display:flex;gap:.5rem;margin-top:1rem}
.modal-actions button{flex:1;padding:.5rem;border-radius:6px;font-size:.85rem;cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--text)}
.modal-actions .confirm{background:var(--purple);border-color:var(--purple);color:#fff}
.modal input[type=number]{width:100%;padding:.5rem .75rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem;outline:none}
.field{margin-bottom:1rem}
.field label{display:block;font-size:.85rem;font-weight:600;margin-bottom:.35rem;color:var(--muted)}
#pricing-table input[type=number]{width:100%;padding:.4rem .5rem;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;outline:none;min-width:80px}
#pricing-table input[type=number]:focus{border-color:var(--purple)}
.save-btn{display:inline-block;padding:.5rem 1.5rem;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;background:var(--purple);color:#fff;margin-top:.5rem}
.save-btn:hover{opacity:.9}
.save-btn:disabled{opacity:.4;cursor:not-allowed}
@media(max-width:700px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .pricing-grid{grid-template-columns:1fr}
  .container{padding:1rem}
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <div class="logo"><span>noscha</span><span>.io</span></div>
  <p class="sub">Admin Dashboard</p>
  <div class="section">
    <p id="nostr-status" style="text-align:center;margin-bottom:1rem;font-size:.85rem;color:var(--muted)">Checking for NIP-07 extension...</p>
    <button class="btn btn-primary" id="login-btn" disabled>Login with Nostr</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none">
<div class="container">
  <div class="header">
    <div class="logo"><span>noscha</span><span>.io</span><span>admin</span></div>
    <button class="logout-btn" id="logout-btn">Logout</button>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat-card"><div class="stat-val" id="s-active">-</div><div class="stat-label">Active</div></div>
    <div class="stat-card"><div class="stat-val warn" id="s-expiring">-</div><div class="stat-label">Expiring (7d)</div></div>
    <div class="stat-card"><div class="stat-val" id="s-banned">-</div><div class="stat-label">Banned</div></div>
    <div class="stat-card"><div class="stat-val revenue" id="s-revenue">-</div><div class="stat-label">Revenue (sats)</div></div>
  </div>

  <!-- Pricing -->
  <div class="section">
    <h2>Pricing (sats)</h2>
    <div class="tbl-wrap">
      <table id="pricing-table">
        <thead>
          <tr><th>Duration</th><th>Subdomain</th><th>Email</th><th>NIP-05</th><th style="color:var(--green)">Bundle</th><th>Del</th></tr>
        </thead>
        <tbody id="pricing-body">
        </tbody>
      </table>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.75rem;flex-wrap:wrap">
      <input type="text" id="new-period-key" placeholder="Period key (e.g. 2h)" style="width:100px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <input type="number" id="new-period-dur" placeholder="Minutes" style="width:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <input type="number" id="new-period-sub" placeholder="Subdomain" style="width:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <input type="number" id="new-period-email" placeholder="Email" style="width:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <input type="number" id="new-period-nip" placeholder="NIP-05" style="width:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <input type="number" id="new-period-bundle" placeholder="Bundle" style="width:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.85rem;padding:.4rem .5rem;outline:none">
      <button class="save-btn" onclick="addPeriod()">Add</button>
    </div>
    <button class="save-btn" id="save-pricing-btn" style="margin-top:1rem">Save Pricing</button>
    <span id="pricing-status" style="margin-left:.75rem;font-size:.8rem;color:var(--muted)"></span>
  </div>

  <!-- Debug Webhook -->
  <div class="section">
    <h2>Debug Webhook</h2>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:1rem">Email Worker のログを Discord 等に送信。診断用。</p>
    <div class="field">
      <label>Webhook URL</label>
      <input type="text" id="debug-webhook-url" placeholder="https://discord.com/api/webhooks/..." style="width:100%;max-width:480px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem;padding:.5rem .75rem;outline:none">
    </div>
    <div class="field" style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
        <input type="checkbox" id="debug-webhook-enabled">
        <span>有効</span>
      </label>
      <label style="display:flex;align-items:center;gap:.5rem">
        <span style="color:var(--muted);font-size:.85rem">通知レベル:</span>
        <select id="debug-webhook-level" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem;padding:.4rem .6rem;outline:none">
          <option value="off">off</option>
          <option value="error">error</option>
          <option value="warn">warn</option>
          <option value="info">info</option>
          <option value="debug">debug</option>
        </select>
      </label>
    </div>
    <button class="save-btn" id="save-debug-webhook-btn">Save</button>
    <span id="debug-webhook-status" style="margin-left:.75rem;font-size:.8rem;color:var(--muted)"></span>
  </div>

  <!-- Rentals -->
  <div class="section">
    <h2>Rentals</h2>
    <div class="toolbar">
      <button class="filter-btn active" data-filter="">All</button>
      <button class="filter-btn" data-filter="active">Active</button>
      <button class="filter-btn" data-filter="expired">Expired</button>
      <button class="filter-btn" data-filter="banned">Banned</button>
      <div class="toolbar-spacer"></div>
      <button class="page-btn" id="prev-btn" disabled>&lt; Prev</button>
      <span class="page-info" id="page-info">-</span>
      <button class="page-btn" id="next-btn" disabled>Next &gt;</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead>
          <tr><th>User</th><th>My Page</th><th>Status</th><th>Plan</th><th>Remaining</th><th>Services</th><th>Actions</th></tr>
        </thead>
        <tbody id="rentals-body"><tr><td colspan="7" style="text-align:center;color:var(--muted)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- Extend Modal -->
<div class="modal-bg" id="extend-modal">
  <div class="modal">
    <h3>Extend rental: <span id="extend-user"></span></h3>
    <div class="field">
      <label>Minutes to add</label>
      <input type="number" id="extend-minutes" value="1440" min="1" max="525600">
    </div>
    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="confirm" id="extend-confirm">Extend</button>
    </div>
  </div>
</div>

<!-- Edit Webhook Modal -->
<div class="modal-bg" id="webhook-modal">
  <div class="modal" style="width:400px">
    <h3>Edit webhook: <span id="webhook-user"></span></h3>
    <div class="field">
      <label>Webhook URL</label>
      <input type="text" id="webhook-url-input" placeholder="https://discord.com/api/webhooks/..." style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem;padding:.5rem .75rem;outline:none">
    </div>
    <p style="font-size:.8rem;color:var(--muted);margin-bottom:1rem">Leave empty to disable. Discord webhook URL recommended.</p>
    <div class="modal-actions">
      <button onclick="closeWebhookModal()">Cancel</button>
      <button class="confirm" id="webhook-save">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function(){
  var token = localStorage.getItem('noscha_admin_session') || '';
  var currentPage = 1;
  var currentFilter = '';
  var pageLimit = 20;
  var pricingData = {};
  var currentRentals = [];

  var loginScreen = document.getElementById('login-screen');
  var dashboard = document.getElementById('dashboard');
  var loginBtn = document.getElementById('login-btn');
  var loginErr = document.getElementById('login-err');
  var logoutBtn = document.getElementById('logout-btn');
  var nostrStatus = document.getElementById('nostr-status');
  var rentalsBody = document.getElementById('rentals-body');
  var prevBtn = document.getElementById('prev-btn');
  var nextBtn = document.getElementById('next-btn');
  var pageInfo = document.getElementById('page-info');

  // Check NIP-07
  function checkNostr() {
    if (window.nostr) {
      nostrStatus.textContent = 'NIP-07 extension detected ✓';
      nostrStatus.style.color = 'var(--green)';
      loginBtn.disabled = false;
    } else {
      nostrStatus.textContent = 'No NIP-07 extension found. Install nos2x, Alby, or similar.';
      nostrStatus.style.color = 'var(--red)';
      loginBtn.disabled = true;
    }
  }

  // Wait a bit for extension to load
  if (window.nostr) { checkNostr(); } else { setTimeout(checkNostr, 500); }

  // Auto-login if session saved
  if (token) {
    apiFetch('/api/admin/stats').then(function() {
      showDashboard();
    }).catch(function() {
      token = '';
      localStorage.removeItem('noscha_admin_session');
    });
  }

  loginBtn.addEventListener('click', doLogin);

  async function doLogin() {
    loginErr.textContent = '';
    loginBtn.disabled = true;
    try {
      // 1. Get challenge
      var chRes = await fetch('/api/admin/challenge', { method: 'POST' });
      if (!chRes.ok) throw new Error('Failed to get challenge');
      var chData = await chRes.json();
      var challenge = chData.challenge;

      // 2. Sign with NIP-07
      var event = {
        kind: 27235,
        created_at: Math.floor(Date.now() / 1000),
        tags: [],
        content: challenge
      };
      var signedEvent = await window.nostr.signEvent(event);

      // 3. Send to login
      var loginRes = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(signedEvent)
      });
      if (!loginRes.ok) {
        var errText = await loginRes.text();
        throw new Error(errText);
      }
      var loginData = await loginRes.json();
      token = loginData.token;
      localStorage.setItem('noscha_admin_session', token);
      showDashboard();
    } catch (e) {
      loginErr.textContent = e.message || 'Login failed';
      loginBtn.disabled = false;
    }
  }

  logoutBtn.addEventListener('click', function() {
    token = '';
    localStorage.removeItem('noscha_admin_session');
    dashboard.style.display = 'none';
    loginScreen.style.display = 'block';
    loginBtn.disabled = false;
    loginErr.textContent = '';
    checkNostr();
  });

  function showDashboard() {
    loginScreen.style.display = 'none';
    dashboard.style.display = 'block';
    loadStats();
    loadRentals();
    loadPricing();
    loadDebugWebhook();
  }

  function apiFetch(path, opts) {
    opts = opts || {};
    opts.headers = opts.headers || {};
    opts.headers['X-Admin-Token'] = token;
    return fetch(path, opts).then(function(r) {
      if (r.status === 401) throw new Error('Unauthorized');
      if (!r.ok) return r.text().then(function(t) { throw new Error(t); });
      var ct = r.headers.get('content-type') || '';
      if (ct.indexOf('json') !== -1) return r.json();
      return r.text();
    });
  }

  function loadStats() {
    apiFetch('/api/admin/stats').then(function(d) {
      document.getElementById('s-active').textContent = d.active_rentals;
      document.getElementById('s-expiring').textContent = d.expiring_soon;
      document.getElementById('s-banned').textContent = d.banned_users;
      document.getElementById('s-revenue').textContent = d.total_revenue_sats.toLocaleString();
    });
  }

  function parseDurationMinutes(key) {
    var m = key.match(/^(\d+)(m|h|d)$/);
    if (!m) return 0;
    var n = parseInt(m[1], 10);
    if (m[2] === 'h') return n * 60;
    if (m[2] === 'd') return n * 1440;
    return n;
  }

  function loadPricing() {
    apiFetch('/api/admin/pricing').then(function(d) {
      pricingData = d;
      renderPricing();
    });
  }

  function renderPricing() {
    var body = document.getElementById('pricing-body');
    var keys = Object.keys(pricingData);
    keys.sort(function(a, b) { return parseDurationMinutes(a) - parseDurationMinutes(b); });
    var html = '';
    keys.forEach(function(p) {
      var row = pricingData[p];
      html += '<tr>';
      html += '<td>' + esc(p) + '</td>';
      html += '<td><input type="number" data-period="' + esc(p) + '" data-svc="subdomain" value="' + (row.subdomain || 0) + '"></td>';
      html += '<td><input type="number" data-period="' + esc(p) + '" data-svc="email" value="' + (row.email || 0) + '"></td>';
      html += '<td><input type="number" data-period="' + esc(p) + '" data-svc="nip05" value="' + (row.nip05 || 0) + '"></td>';
      html += '<td><input type="number" data-period="' + esc(p) + '" data-svc="bundle" value="' + (row.bundle || 0) + '"></td>';
      html += '<td><button class="act-btn act-revoke" onclick="deletePeriod(\'' + esc(p) + '\')">X</button></td>';
      html += '</tr>';
    });
    body.innerHTML = html;
  }

  window.deletePeriod = function(key) {
    delete pricingData[key];
    renderPricing();
  };

  window.addPeriod = function() {
    var key = document.getElementById('new-period-key').value.trim();
    var dur = parseInt(document.getElementById('new-period-dur').value, 10);
    var sub = parseInt(document.getElementById('new-period-sub').value, 10) || 0;
    var email = parseInt(document.getElementById('new-period-email').value, 10) || 0;
    var nip = parseInt(document.getElementById('new-period-nip').value, 10) || 0;
    var bundle = parseInt(document.getElementById('new-period-bundle').value, 10) || 0;
    if (!key) { toast('Period key is required', 'err'); return; }
    if (!dur || dur < 1) { toast('Minutes must be >= 1', 'err'); return; }
    pricingData[key] = { subdomain: sub, email: email, nip05: nip, bundle: bundle, _duration_minutes: dur };
    document.getElementById('new-period-key').value = '';
    document.getElementById('new-period-dur').value = '';
    document.getElementById('new-period-sub').value = '';
    document.getElementById('new-period-email').value = '';
    document.getElementById('new-period-nip').value = '';
    document.getElementById('new-period-bundle').value = '';
    renderPricing();
  };

  document.getElementById('save-pricing-btn').addEventListener('click', function() {
    var btn = this;
    var status = document.getElementById('pricing-status');
    btn.disabled = true;
    status.textContent = 'Saving...';
    // Update pricingData from current input values
    var inputs = document.querySelectorAll('#pricing-table input[data-period]');
    inputs.forEach(function(el) {
      var p = el.getAttribute('data-period');
      var s = el.getAttribute('data-svc');
      if (!pricingData[p]) pricingData[p] = {};
      pricingData[p][s] = parseInt(el.value, 10) || 0;
    });
    apiFetch('/api/admin/pricing', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pricingData)
    }).then(function() {
      status.textContent = 'Saved ✓';
      status.style.color = 'var(--green)';
      toast('Pricing updated', 'ok');
      btn.disabled = false;
    }).catch(function(e) {
      status.textContent = 'Error: ' + e.message;
      status.style.color = 'var(--red)';
      btn.disabled = false;
    });
  });

  function loadDebugWebhook() {
    apiFetch('/api/admin/debug-webhook').then(function(d) {
      document.getElementById('debug-webhook-url').value = d.webhook_url || '';
      document.getElementById('debug-webhook-enabled').checked = !!d.enabled;
      document.getElementById('debug-webhook-level').value = d.level || 'off';
      document.getElementById('debug-webhook-status').textContent = '';
    }).catch(function() {
      document.getElementById('debug-webhook-status').textContent = 'Load failed';
      document.getElementById('debug-webhook-status').style.color = 'var(--red)';
    });
  }

  document.getElementById('save-debug-webhook-btn').addEventListener('click', function() {
    var btn = this;
    var status = document.getElementById('debug-webhook-status');
    var enabled = document.getElementById('debug-webhook-enabled').checked;
    var url = document.getElementById('debug-webhook-url').value.trim();
    var level = document.getElementById('debug-webhook-level').value;

    if (enabled && !url) {
      status.textContent = 'Webhook URL required when enabled';
      status.style.color = 'var(--red)';
      return;
    }

    btn.disabled = true;
    status.textContent = 'Saving...';
    apiFetch('/api/admin/debug-webhook', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled, webhook_url: url, level: level })
    }).then(function() {
      status.textContent = 'Saved ✓';
      status.style.color = 'var(--green)';
      toast('Debug webhook updated', 'ok');
      btn.disabled = false;
    }).catch(function(e) {
      status.textContent = 'Error: ' + e.message;
      status.style.color = 'var(--red)';
      btn.disabled = false;
    });
  });

  function loadRentals() {
    var url = '/api/admin/rentals?page=' + currentPage + '&limit=' + pageLimit;
    if (currentFilter) url += '&status=' + currentFilter;
    apiFetch(url).then(function(d) {
      currentRentals = d.rentals;
      renderRentals(d.rentals);
      var totalPages = Math.max(1, Math.ceil(d.total / d.limit));
      pageInfo.textContent = 'Page ' + d.page + ' / ' + totalPages + ' (' + d.total + ' total)';
      prevBtn.disabled = d.page <= 1;
      nextBtn.disabled = d.page >= totalPages;
    });
  }

  function renderRentals(list) {
    if (!list.length) {
      rentalsBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted)">No rentals found</td></tr>';
      return;
    }
    var origin = window.location.origin || 'https://noscha.io';
    var html = '';
    list.forEach(function(r) {
      var badgeCls = r.status === 'active' ? 'badge-active' : r.status === 'banned' ? 'badge-banned' : 'badge-expired';
      if (r.status === 'active' && r.minutes_remaining <= 4320) badgeCls = 'badge-warn';
      var daysText = r.minutes_remaining > 0 ? (r.minutes_remaining < 60 ? r.minutes_remaining + 'm' : r.minutes_remaining < 1440 ? Math.round(r.minutes_remaining / 60) + 'h' : Math.round(r.minutes_remaining / 1440) + 'd') : 'expired';
      var svcs = '';
      svcs += '<span class="svc-pill' + (r.has_email ? ' on' : '') + '">Email</span>';
      svcs += '<span class="svc-pill' + (r.has_subdomain ? ' on' : '') + '">DNS</span>';
      svcs += '<span class="svc-pill' + (r.has_nip05 ? ' on' : '') + '">NIP-05</span>';
      var myPageCell = '-';
      if (r.management_token) {
        var myPageUrl = origin + '/my/' + r.management_token;
        myPageCell = '<a href="' + esc(myPageUrl) + '" target="_blank" rel="noopener">My Page</a>';
      }
      var actions = '';
      if (r.status === 'banned') {
        actions += '<button class="act-btn act-unban" onclick="doUnban(\'' + esc(r.username) + '\')">Unban</button>';
      } else {
        if (r.status === 'active') {
          actions += '<button class="act-btn act-extend" onclick="openExtend(\'' + esc(r.username) + '\')">Extend</button>';
          actions += '<button class="act-btn act-revoke" onclick="doRevoke(\'' + esc(r.username) + '\')">Revoke</button>';
        }
        actions += '<button class="act-btn" onclick="openEditWebhook(\'' + esc(r.username) + '\')">Edit Webhook</button>';
        actions += '<button class="act-btn act-ban" onclick="doBan(\'' + esc(r.username) + '\')">Ban</button>';
      }
      html += '<tr>';
      html += '<td><strong>' + esc(r.username) + '</strong></td>';
      html += '<td>' + myPageCell + '</td>';
      html += '<td><span class="badge ' + badgeCls + '">' + esc(r.status) + '</span></td>';
      html += '<td>' + esc(r.plan) + '</td>';
      html += '<td>' + daysText + '</td>';
      html += '<td>' + svcs + '</td>';
      html += '<td>' + actions + '</td>';
      html += '</tr>';
    });
    rentalsBody.innerHTML = html;
  }

  function esc(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }

  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter');
      currentPage = 1;
      loadRentals();
    });
  });

  prevBtn.addEventListener('click', function() { if (currentPage > 1) { currentPage--; loadRentals(); } });
  nextBtn.addEventListener('click', function() { currentPage++; loadRentals(); });

  window.doBan = function(username) {
    if (!confirm('Ban user "' + username + '"? Their services will be stopped.')) return;
    apiFetch('/api/admin/ban/' + encodeURIComponent(username), { method: 'POST' }).then(function() {
      toast('Banned: ' + username, 'ok'); loadStats(); loadRentals();
    }).catch(function(e) { toast('Error: ' + e.message, 'err'); });
  };

  window.doUnban = function(username) {
    if (!confirm('Unban user "' + username + '"?')) return;
    apiFetch('/api/admin/unban/' + encodeURIComponent(username), { method: 'POST' }).then(function() {
      toast('Unbanned: ' + username, 'ok'); loadStats(); loadRentals();
    }).catch(function(e) { toast('Error: ' + e.message, 'err'); });
  };

  window.doRevoke = function(username) {
    if (!confirm('Revoke rental for "' + username + '"? Services will be stopped immediately.')) return;
    apiFetch('/api/admin/revoke/' + encodeURIComponent(username), { method: 'POST' }).then(function() {
      toast('Revoked: ' + username, 'ok'); loadStats(); loadRentals();
    }).catch(function(e) { toast('Error: ' + e.message, 'err'); });
  };

  window.openExtend = function(username) {
    document.getElementById('extend-user').textContent = username;
    document.getElementById('extend-minutes').value = 1440;
    document.getElementById('extend-modal').classList.add('open');
    document.getElementById('extend-confirm').onclick = function() {
      var minutes = parseInt(document.getElementById('extend-minutes').value, 10);
      if (!minutes || minutes < 1 || minutes > 525600) { toast('Minutes must be 1-525600', 'err'); return; }
      apiFetch('/api/admin/extend/' + encodeURIComponent(username), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ minutes: minutes })
      }).then(function() {
        closeModal(); toast('Extended ' + username + ' by ' + minutes + ' minutes', 'ok'); loadStats(); loadRentals();
      }).catch(function(e) { toast('Error: ' + e.message, 'err'); });
    };
  };

  window.closeModal = function() {
    document.getElementById('extend-modal').classList.remove('open');
  };

  window.openEditWebhook = function(username) {
    var r = currentRentals.find(function(x) { return x.username === username; });
    var currentUrl = (r && r.webhook_url) ? r.webhook_url : '';
    document.getElementById('webhook-user').textContent = username;
    document.getElementById('webhook-url-input').value = currentUrl;
    document.getElementById('webhook-modal').classList.add('open');
    document.getElementById('webhook-save').onclick = function() {
      var url = document.getElementById('webhook-url-input').value.trim();
      apiFetch('/api/admin/rentals/' + encodeURIComponent(username) + '/webhook', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ webhook_url: url || null })
      }).then(function() {
        closeWebhookModal(); toast('Webhook updated', 'ok'); loadRentals();
      }).catch(function(e) { toast('Error: ' + e.message, 'err'); });
    };
  };

  window.closeWebhookModal = function() {
    document.getElementById('webhook-modal').classList.remove('open');
  };

  var toastTimer;
  function toast(msg, type) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show ' + (type || '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { el.className = 'toast'; }, 3000);
  }
})();
</script>
<footer style="text-align:center;padding:1rem;color:#666;font-size:0.75rem;">v2026.02.11 · <a href="https://github.com/kojira/noscha-io" target="_blank" rel="noopener" style="color:#888;text-decoration:none;">GitHub</a></footer>
</body>
</html>
