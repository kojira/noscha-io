<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>noscha.io — Lightning-powered identity services</title>
<meta name="description" content="Lightning Network powered disposable email, subdomain &amp; NIP-05 service. No KYC, no signup, instant activation. Starting from 200 sats.">
<meta name="keywords" content="lightning, bitcoin, nostr, nip-05, email, subdomain, disposable, anonymous, privacy">
<meta property="og:title" content="noscha.io — Lightning-powered identity services">
<meta property="og:description" content="Disposable email, subdomain &amp; NIP-05 via Lightning Network. No KYC, instant activation from 200 sats.">
<meta property="og:image" content="https://noscha.io/og-image.png">
<meta property="og:url" content="https://noscha.io">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="noscha.io — Lightning-powered identity services">
<meta name="twitter:description" content="Disposable email, subdomain &amp; NIP-05 via Lightning Network. No KYC, instant activation from 200 sats.">
<meta name="twitter:image" content="https://noscha.io/og-image.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--surface:#111;--border:#222;--text:#c0c0c0;--muted:#666;--accent:#00ff88;--accent-dim:#00cc6a;--orange:#f7931a;--orange-dim:#c2410c;--green:#00ff88;--red:#ff4444}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.accent{color:var(--accent)}
.container{max-width:700px;margin:0 auto;padding:2rem 1.5rem}

/* Header */
.logo{font-size:1.6rem;font-weight:700;text-align:center;margin-bottom:.5rem;letter-spacing:-.02em;color:var(--text)}
.tagline{text-align:center;color:var(--muted);font-size:.82rem;margin-bottom:1rem;line-height:1.5}

/* Curl box */
.curl-box{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:.6rem .85rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
.curl-box code{font-size:.78rem;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.curl-box .curl-prefix{color:var(--muted);font-size:.78rem;user-select:none}
.curl-copy-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:.7rem;padding:.25rem .5rem;cursor:pointer;font-family:inherit;white-space:nowrap;transition:color .15s,border-color .15s}
.curl-copy-btn:hover{color:var(--accent);border-color:var(--accent)}

/* Doc links */
.doc-links{display:flex;justify-content:center;gap:1rem;margin-bottom:2rem;font-size:.78rem}
.doc-links a{color:var(--muted);border:1px solid var(--border);border-radius:4px;padding:.3rem .6rem;transition:color .15s,border-color .15s}
.doc-links a:hover{color:var(--accent);border-color:var(--accent);text-decoration:none}

/* Sections */
.section{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1.5rem;margin-bottom:1.5rem}
.section h2{font-size:.9rem;margin-bottom:1rem;color:var(--text);text-transform:uppercase;letter-spacing:.08em;font-weight:600}

/* Features */
.features{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem;margin-bottom:1.5rem}
.feat{text-align:center;padding:.85rem .5rem;border:1px solid var(--border);border-radius:4px;background:var(--surface)}
.feat-icon{font-size:1.3rem;margin-bottom:.25rem}
.feat-title{font-size:.8rem;font-weight:600;color:var(--text)}
.feat-desc{font-size:.7rem;color:var(--muted)}

/* Pricing */
.pricing-wrap{overflow-x:auto}
.pricing-table{width:100%;border-collapse:collapse;font-size:.8rem}
.pricing-table th{text-align:left;padding:.4rem .6rem;border-bottom:1px solid var(--border);color:var(--muted);font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.pricing-table td{padding:.4rem .6rem;border-bottom:1px solid #1a1a1a}
.pricing-table tr:last-child td{border-bottom:none}
.price{color:var(--orange);font-weight:600}
.pricing-json{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.75rem;margin-top:.75rem;font-size:.68rem;color:var(--muted);overflow-x:auto;white-space:pre;line-height:1.5;max-height:260px;overflow-y:auto}

/* Form */
.field{margin-bottom:1.25rem}
.field label{display:block;font-size:.78rem;font-weight:600;margin-bottom:.35rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
input[type=text],input[type=email]{width:100%;padding:.55rem .7rem;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:16px;font-family:inherit;outline:none;transition:border-color .15s}
input:focus{border-color:var(--accent)}
.input-hint{font-size:.72rem;margin-top:.25rem;min-height:1.1em}
.hint-ok{color:var(--green)}
.hint-err{color:var(--red)}
.hint-loading{color:var(--muted)}

/* Radio plan selector */
.plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:.5rem}
.plan-opt{position:relative}
.plan-opt input{position:absolute;opacity:0;pointer-events:none}
.plan-opt label{display:block;text-align:center;padding:.55rem .25rem;border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:.75rem;transition:all .15s;background:var(--bg)}
.plan-opt label .dur{display:block;font-weight:600;color:var(--text)}
.plan-opt label .sat{display:block;font-size:.65rem;color:var(--orange)}
.plan-opt input:checked+label{border-color:var(--accent);background:#00ff8810;color:var(--accent)}
.plan-opt input:checked+label .dur{color:var(--accent)}
.plan-opt input:checked+label .sat{color:var(--orange)}

/* Service toggles */
.svc-toggle{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;cursor:pointer;font-size:.82rem}
.svc-toggle input[type=checkbox]{accent-color:var(--accent);width:14px;height:14px}
.svc-fields{padding-left:1.5rem;margin-bottom:1rem;display:none}
.svc-fields.open{display:block}
.svc-fields .field{margin-bottom:.75rem}
.svc-fields .field:last-child{margin-bottom:0}
.inline-row{display:flex;gap:.5rem;align-items:center}
.inline-row select{padding:.55rem .5rem;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:16px;font-family:inherit;outline:none}
.inline-row input[type=text]{flex:1}
.check-row{display:flex;align-items:center;gap:.4rem;margin-top:.35rem;font-size:.75rem;color:var(--muted)}
.check-row input{accent-color:var(--accent)}

/* Buttons */
.btn{display:block;width:100%;padding:.7rem;border:none;border-radius:4px;font-size:.88rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-primary{background:var(--accent);color:#0a0a0a}
.btn-primary:hover{background:var(--accent-dim)}
.btn-primary:disabled{opacity:.3;cursor:not-allowed}
.btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text);margin-top:.75rem}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}

/* Payment screen */
#payment-screen{display:none}
.qr-wrap{text-align:center;margin:1.5rem 0}
.qr-wrap #qrcode{display:inline-block;padding:12px;background:#fff;border-radius:4px}
.bolt11-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.75rem;word-break:break-all;font-size:.7rem;color:var(--muted);cursor:pointer;position:relative;margin-bottom:1rem;font-family:inherit}
.bolt11-box:hover{border-color:var(--accent)}
.bolt11-box::after{content:'click to copy';position:absolute;right:.5rem;top:.5rem;font-size:.6rem;color:var(--accent)}
.status-badge{display:inline-block;padding:.2rem .6rem;border-radius:4px;font-size:.78rem;font-weight:600}
.status-pending{background:#f7931a18;color:var(--orange)}
.status-paid{background:#00ff8818;color:var(--green)}
.status-provisioned{background:#00ff8818;color:var(--accent)}
.poll-info{text-align:center;color:var(--muted);font-size:.75rem;margin-top:.5rem}

/* Success */
.success-box{text-align:center;padding:2rem 1rem}
.success-check{font-size:2.5rem;margin-bottom:.5rem;color:var(--green)}
.success-title{font-size:1.1rem;font-weight:700;color:var(--green);margin-bottom:.5rem}
.success-detail{font-size:.8rem;color:var(--muted)}
.mgmt-section{margin-top:1.5rem;text-align:left}
.mgmt-link{display:block;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.75rem;margin:.5rem 0;word-break:break-all;text-align:center}
.mgmt-link a{color:var(--accent);font-weight:600;font-size:.85rem}
.mgmt-warning{background:#f7931a12;border:1px solid #f7931a44;border-radius:4px;padding:.6rem .75rem;font-size:.75rem;color:var(--orange);margin-top:.75rem;text-align:center}
.copy-btn{display:inline-block;padding:.35rem .7rem;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.75rem;cursor:pointer;font-family:inherit;margin-top:.5rem;transition:all .15s}
.copy-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Responsive */
@media(max-width:600px){
  .features{grid-template-columns:1fr}
  .plans{grid-template-columns:repeat(auto-fit,minmax(70px,1fr))}
  .container{padding:1.25rem 1rem}
  .inline-row{flex-direction:column}
  .inline-row select,.inline-row input[type=text]{width:100%}
  .doc-links{flex-wrap:wrap;gap:.5rem}
  .curl-box{flex-direction:column;align-items:stretch;gap:.4rem}
  .curl-box code{font-size:.7rem}
  .pricing-wrap{-webkit-overflow-scrolling:touch}
  input[type=text],input[type=email],select,textarea{font-size:16px !important}
  .pricing-table{font-size:.7rem}
}
</style>
</head>
<body>

<div class="container">
  <div class="logo">noscha.io</div>
  <p class="tagline">Disposable Infrastructure for <span class="accent">AI Agents</span><br>Pay with Lightning. No account needed. Humans welcome to observe.</p>

  <!-- Curl box -->
  <div class="curl-box">
    <code><span class="curl-prefix">$ </span>curl -s https://noscha.io/llms.txt</code>
    <button class="curl-copy-btn" id="curl-copy-btn">copy</button>
  </div>

  <!-- Doc links -->
  <div class="doc-links">
    <a href="/llms.txt">/llms.txt</a>
    <a href="/skill.md">/skill.md</a>
    <a href="/api/docs">/api/docs</a>
  </div>

  <!-- Info Section -->
  <div id="info-section">
    <div class="features">
      <div class="feat"><div class="feat-icon">&#9993;</div><div class="feat-title">Email</div><div class="feat-desc">username@noscha.io notifications</div></div>
      <div class="feat"><div class="feat-icon">&#127760;</div><div class="feat-title">Subdomain</div><div class="feat-desc">username.noscha.io DNS</div></div>
      <div class="feat"><div class="feat-icon">&#9889;</div><div class="feat-title">NIP-05</div><div class="feat-desc">Nostr identity verification</div></div>
    </div>

    <div class="section">
      <h2>Pricing (per service)</h2>
      <div class="pricing-wrap">
      <table class="pricing-table">
        <tr><th>Duration</th><th>Subdomain</th><th>Email</th><th>NIP-05</th><th style="color:var(--green)">All Services (Email + Subdomain + NIP-05)</th></tr>
        <tbody id="pricing-body">
        <tr><td colspan="5" style="text-align:center;color:var(--muted)">Loading prices...</td></tr>
        </tbody>
      </table>
      </div>
      <div class="pricing-json" id="pricing-json" style="display:none"></div>
      <p style="font-size:.68rem;color:var(--muted);margin-top:.5rem">* All prices in sats. Select all 3 services for the bundle discount.</p>
    </div>

    <!-- Order Form -->
    <div class="section" id="order-section">
      <h2>Get started</h2>

      <div class="field">
        <label>Username</label>
        <input type="text" id="username" placeholder="satoshi" autocomplete="off" spellcheck="false">
        <div class="input-hint" id="username-hint"></div>
      </div>

      <div class="field">
        <label>Webhook URL <span style="color:var(--red);font-size:.65rem">(required)</span></label>
        <input type="text" id="webhook-url" placeholder="https://discord.com/api/webhooks/..." autocomplete="off" spellcheck="false">
        <div class="input-hint" style="color:var(--muted);font-size:.7rem;margin-top:.25rem">Notifications will be sent here. Discord webhooks recommended.</div>
      </div>

      <div class="field">
        <label>Plan</label>
        <div class="plans">
          <div class="plan-opt"><input type="radio" name="plan" id="p1h" value="1h"><label for="p1h"><span class="dur">1 hour</span></label></div>
          <div class="plan-opt"><input type="radio" name="plan" id="p1d" value="1d"><label for="p1d"><span class="dur">1 day</span></label></div>
          <div class="plan-opt"><input type="radio" name="plan" id="p7d" value="7d" checked><label for="p7d"><span class="dur">1 week</span></label></div>
          <div class="plan-opt"><input type="radio" name="plan" id="p30d" value="30d"><label for="p30d"><span class="dur">1 month</span></label></div>
          <div class="plan-opt"><input type="radio" name="plan" id="p90d" value="90d"><label for="p90d"><span class="dur">3 months</span></label></div>
          <div class="plan-opt"><input type="radio" name="plan" id="p365d" value="365d"><label for="p365d"><span class="dur">1 year</span></label></div>
        </div>
      </div>

      <div class="field">
        <label>Services</label>

        <label class="svc-toggle"><input type="checkbox" id="svc-email"> Email notifications</label>
        <div class="svc-fields" id="svc-email-fields">
          <div style="font-size:.7rem;color:var(--muted);margin-top:.5rem;line-height:1.5">
            Incoming emails will be delivered via webhook notification to your webhook URL.<br>
            ! Each user is limited to 5 emails per 24 hours.
          </div>
        </div>

        <label class="svc-toggle"><input type="checkbox" id="svc-subdomain"> Subdomain DNS</label>
        <div class="svc-fields" id="svc-subdomain-fields">
          <div class="field">
            <label>DNS Record</label>
            <div class="inline-row">
              <select id="dns-type">
                <option value="CNAME">CNAME</option>
                <option value="A">A</option>
                <option value="AAAA">AAAA</option>
              </select>
              <input type="text" id="dns-target" placeholder="target (e.g. mysite.example.com)">
            </div>
            <div class="check-row"><input type="checkbox" id="dns-proxied"> Cloudflare proxy (orange cloud)</div>
          </div>
        </div>

        <label class="svc-toggle"><input type="checkbox" id="svc-nip05"> NIP-05 Nostr identity</label>
        <div class="svc-fields" id="svc-nip05-fields">
          <div class="field">
            <label>Nostr public key (hex)</label>
            <input type="text" id="nip05-pubkey" placeholder="npub hex pubkey (64 chars)">
          </div>
        </div>
      </div>

      <div id="total-display" style="text-align:center;padding:.65rem;margin-bottom:1rem;border:1px solid var(--border);border-radius:4px;background:var(--bg);display:none">
        <span style="color:var(--muted);font-size:.78rem">Total: </span>
        <span id="total-sats" style="font-size:1.1rem;font-weight:700;color:var(--orange)">0 sats</span>
        <div id="bundle-badge" style="display:none;margin-top:.25rem;font-size:.7rem;font-weight:600;color:var(--green)">All-in bundle discount applied!</div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:.75rem 1rem;margin-bottom:1rem;font-size:.72rem;color:var(--muted);line-height:1.6">
        <div style="font-weight:600;color:var(--text);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.04em;font-size:.7rem">Terms of Service</div>
        <ul style="margin:0;padding-left:1.2rem">
          <li>No spam or bulk email usage</li>
          <li>No illegal activities</li>
          <li>Service may be suspended for abuse</li>
          <li>Received emails are automatically deleted after 1 hour</li>
          <li>Email limits apply (5/day per user)</li>
          <li>noscha.io reserves the right to terminate accounts that violate these terms</li>
        </ul>
        <label style="display:flex;align-items:center;gap:.4rem;margin-top:.6rem;cursor:pointer;color:var(--text);font-size:.75rem">
          <input type="checkbox" id="tos-agree"> I agree to the Terms of Service
        </label>
      </div>

      <button class="btn btn-primary" id="order-btn" disabled>Pay with Lightning</button>
    </div>
  </div>

  <!-- Payment Screen -->
  <div id="payment-screen">
    <div class="section">
      <h2>Payment</h2>
      <div style="text-align:center;margin-bottom:1rem">
        <span class="status-badge status-pending" id="pay-status-badge">waiting for payment</span>
      </div>
      <div class="qr-wrap"><div id="qrcode"></div></div>
      <div class="bolt11-box" id="bolt11-box" title="Click to copy"></div>
      <div style="text-align:center">
        <span id="pay-amount" style="font-size:1rem;font-weight:700;color:var(--orange)"></span>
      </div>
      <div class="poll-info" id="poll-info">Checking payment status...</div>
      <button class="btn btn-secondary" id="back-btn">Cancel</button>
    </div>

    <!-- Success (shown after payment confirmed) -->
    <div id="success-box" class="section" style="display:none">
      <div class="success-box">
        <div class="success-check">&#10003;</div>
        <div class="success-title">Payment complete!</div>
        <div class="success-detail" id="success-detail"></div>
        <div class="mgmt-section" id="mgmt-section" style="display:none">
          <div class="mgmt-link" id="mgmt-link"></div>
          <div style="text-align:center"><button class="copy-btn" id="copy-token-btn">Copy management token</button></div>
          <div class="mgmt-warning">This URL is your only way to manage your services. Save it now — it cannot be reissued.</div>
        </div>
        <button class="btn btn-secondary" style="margin-top:1.5rem" onclick="location.reload()">New order</button>
      </div>
    </div>
  </div>
</div>

<!-- Donate Section -->
<div class="container" style="padding-top:0">
  <div class="section" style="text-align:center;padding:1.5rem">
    <h2 style="font-size:.85rem;margin-bottom:.75rem">Support noscha.io</h2>
    <p style="color:var(--muted);font-size:.75rem;margin-bottom:1rem">Help keep this service running with a Lightning donation</p>
    <div id="donate-qr" style="display:inline-block;padding:8px;background:#fff;border-radius:4px;margin-bottom:.75rem"></div>
    <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.5rem">
      <code style="font-size:.75rem;color:var(--orange);background:var(--bg);padding:.35rem .7rem;border-radius:4px;border:1px solid var(--border)">nostarou@coinos.io</code>
      <button id="donate-copy-btn" class="curl-copy-btn">copy</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
(function(){
  // Elements
  var usernameEl = document.getElementById('username');
  var hintEl = document.getElementById('username-hint');
  var orderBtn = document.getElementById('order-btn');
  var infoSection = document.getElementById('info-section');
  var payScreen = document.getElementById('payment-screen');
  var bolt11Box = document.getElementById('bolt11-box');
  var payAmount = document.getElementById('pay-amount');
  var payBadge = document.getElementById('pay-status-badge');
  var pollInfo = document.getElementById('poll-info');
  var successBox = document.getElementById('success-box');
  var successDetail = document.getElementById('success-detail');
  var backBtn = document.getElementById('back-btn');

  var usernameOk = false;
  var checkTimer = null;
  var pollTimer = null;
  var currentOrderId = null;
  var currentManagementToken = null;

  // Pricing tables (loaded dynamically)
  var PRICES = {};

  // Load pricing from API
  fetch('/api/pricing').then(function(r){return r.json();}).then(function(d){
    PRICES = d;
    renderPricingTable(d);
    calcTotal();
  });

  function renderPricingTable(prices) {
    var labels = {'1h':'1 hour','1d':'1 day','7d':'1 week','30d':'1 month','90d':'3 months','365d':'1 year'};
    var periods = ['1h','1d','7d','30d','90d','365d'];
    var body = document.getElementById('pricing-body');
    var html = '';
    periods.forEach(function(p) {
      var pr = prices[p] || {};
      html += '<tr><td>'+labels[p]+'</td>';
      html += '<td class="price">'+(pr.subdomain||0).toLocaleString()+'</td>';
      html += '<td class="price">'+(pr.email||0).toLocaleString()+'</td>';
      html += '<td class="price">'+(pr.nip05||0).toLocaleString()+'</td>';
      html += '<td class="price" style="color:var(--green)">'+(pr.bundle||0).toLocaleString()+'</td>';
      html += '</tr>';
    });
    body.innerHTML = html;

    // Build JSON block for 1h–365d
    var jsonData = {};
    periods.forEach(function(p) {
      var pr = prices[p] || {};
      jsonData[p] = {subdomain:pr.subdomain||0, email:pr.email||0, nip05:pr.nip05||0, bundle:pr.bundle||0};
    });
    var jsonEl = document.getElementById('pricing-json');
    jsonEl.textContent = JSON.stringify(jsonData, null, 2);
    jsonEl.style.display = 'block';
  }

  function calcTotal(){
    var plan = document.querySelector('input[name=plan]:checked').value;
    var p = PRICES[plan];
    var hasEmail = document.getElementById('svc-email').checked;
    var hasSub = document.getElementById('svc-subdomain').checked;
    var hasNip = document.getElementById('svc-nip05').checked;
    var count = (hasEmail?1:0)+(hasSub?1:0)+(hasNip?1:0);
    var totalEl = document.getElementById('total-display');
    var satsEl = document.getElementById('total-sats');
    var bundleEl = document.getElementById('bundle-badge');
    if(count===0){totalEl.style.display='none';return 0;}
    totalEl.style.display='block';
    var total;
    if(count===3){total=p.bundle;bundleEl.style.display='block';}
    else{total=(hasEmail?p.email:0)+(hasSub?p.subdomain:0)+(hasNip?p.nip05:0);bundleEl.style.display='none';}
    satsEl.textContent=total.toLocaleString()+' sats';
    return total;
  }

  // Service toggle wiring
  ['email','subdomain','nip05'].forEach(function(s){
    var cb = document.getElementById('svc-'+s);
    var fields = document.getElementById('svc-'+s+'-fields');
    cb.addEventListener('change', function(){
      fields.classList.toggle('open', cb.checked);
      calcTotal();
    });
  });

  // Recalculate on plan change
  document.querySelectorAll('input[name=plan]').forEach(function(r){
    r.addEventListener('change', calcTotal);
  });

  // Username validation with debounce
  usernameEl.addEventListener('input', function(){
    clearTimeout(checkTimer);
    var val = usernameEl.value.trim().toLowerCase();
    usernameEl.value = val;
    usernameOk = false;
    updateOrderBtn();
    if(!val){hintEl.textContent='';hintEl.className='input-hint';return;}
    if(val.length < 3){setHint('Min 3 characters','err');return;}
    if(val.length > 20){setHint('Max 20 characters','err');return;}
    if(!/^[a-z0-9]([a-z0-9_-]*[a-z0-9])?$/.test(val)){setHint('Letters, numbers, hyphens, underscores only','err');return;}
    setHint('Checking...','loading');
    checkTimer = setTimeout(function(){checkUsername(val);}, 400);
  });

  function setHint(msg,type){
    hintEl.textContent = msg;
    hintEl.className = 'input-hint hint-'+type;
  }

  function checkUsername(name){
    fetch('/api/check/'+encodeURIComponent(name))
      .then(function(r){return r.json();})
      .then(function(d){
        if(usernameEl.value.trim().toLowerCase() !== name) return;
        if(d.error){setHint(d.error,'err');usernameOk=false;}
        else if(d.available){setHint(name+'@noscha.io is available','ok');usernameOk=true;}
        else{setHint('Username is taken','err');usernameOk=false;}
        updateOrderBtn();
      })
      .catch(function(){setHint('Check failed','err');});
  }

  function updateOrderBtn(){
    var anyService = document.getElementById('svc-email').checked || document.getElementById('svc-subdomain').checked || document.getElementById('svc-nip05').checked;
    var tosAgreed = document.getElementById('tos-agree').checked;
    var webhookOk = /^https?:\/\//.test(document.getElementById("webhook-url").value.trim());
    orderBtn.disabled = !usernameOk || !anyService || !tosAgreed || !webhookOk;
  }

  // Re-evaluate button on service toggle
  document.querySelectorAll('.svc-toggle input').forEach(function(cb){
    cb.addEventListener('change', function(){ updateOrderBtn(); calcTotal(); });
  });

  // TOS checkbox
  document.getElementById('tos-agree').addEventListener('change', updateOrderBtn);
  document.getElementById("webhook-url").addEventListener("input", updateOrderBtn);

  // Order submission
  orderBtn.addEventListener('click', function(){
    if(orderBtn.disabled) return;
    orderBtn.disabled = true;
    orderBtn.textContent = 'Creating invoice...';

    var services = {};
    if(document.getElementById('svc-email').checked){
      services.email = {};
    }
    if(document.getElementById('svc-subdomain').checked){
      services.subdomain = {
        type: document.getElementById('dns-type').value,
        target: document.getElementById('dns-target').value.trim(),
        proxied: document.getElementById('dns-proxied').checked
      };
    }
    if(document.getElementById('svc-nip05').checked){
      services.nip05 = {pubkey: document.getElementById('nip05-pubkey').value.trim()};
    }

    var plan = document.querySelector('input[name=plan]:checked').value;
    var body = {
      username: usernameEl.value.trim().toLowerCase(),
      plan: plan,
      services: services,
      webhook_url: document.getElementById("webhook-url").value.trim(),
      browser_flow: true
    };

    fetch('/api/order',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    })
    .then(function(r){
      if(!r.ok) return r.text().then(function(t){throw new Error(t);});
      return r.json();
    })
    .then(function(d){
      showPayment(d, body.username);
    })
    .catch(function(e){
      alert('Error: '+(e.message||'Failed to create order'));
      orderBtn.disabled = false;
      orderBtn.textContent = 'Pay with Lightning';
    });
  });

  function showPayment(order, username){
    currentOrderId = order.order_id;
    currentManagementToken = order.management_token || null;
    infoSection.style.display = 'none';
    payScreen.style.display = 'block';
    successBox.style.display = 'none';

    var qrEl = document.getElementById('qrcode');
    qrEl.innerHTML = '';

    if(order.status === 'webhook_pending'){
      // No QR, no bolt11
      bolt11Box.style.display = 'none';
      payBadge.textContent = 'webhook pending';
      payBadge.className = 'status-badge status-pending';
      payAmount.textContent = order.amount_sats + ' sats';
      if(order.challenge_url){
        pollInfo.innerHTML = 'Click the link below to confirm your order and get an invoice:<br><a href="' + order.challenge_url + '" target="_blank" style="color:#8b5cf6;font-weight:600">' + order.challenge_url + '</a>';
      } else {
        pollInfo.textContent = 'A challenge URL has been sent to your webhook. Please confirm it.';
      }
    } else {
      // Normal flow: bolt11 exists
      bolt11Box.style.display = 'block';
      bolt11Box.textContent = order.bolt11;
      payAmount.textContent = order.amount_sats + ' sats';
      payBadge.textContent = 'waiting for payment';
      payBadge.className = 'status-badge status-pending';
      pollInfo.textContent = 'Checking payment status...';

      if(typeof QRCode !== 'undefined'){
        new QRCode(qrEl, {text: order.bolt11, width:220, height:220, colorDark:'#000', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.L});
      }

      // Copy bolt11
      bolt11Box.onclick = function(){
        navigator.clipboard.writeText(order.bolt11).then(function(){
          var orig = bolt11Box.textContent;
          bolt11Box.textContent = 'Copied!';
          setTimeout(function(){bolt11Box.textContent = orig;}, 1500);
        });
      };
    }

    // Poll status
    startPolling(order.order_id, username);
  }

  function startPolling(orderId, username){
    clearInterval(pollTimer);
    pollTimer = setInterval(function(){
      fetch('/api/order/'+encodeURIComponent(orderId)+'/status')
        .then(function(r){return r.json();})
        .then(function(d){
          if(d.status === 'paid' || d.status === 'provisioned'){
            clearInterval(pollTimer);
            if(d.management_token) currentManagementToken = d.management_token;
            payBadge.textContent = d.status === 'provisioned' ? 'provisioned' : 'paid';
            payBadge.className = 'status-badge '+(d.status === 'provisioned' ? 'status-provisioned' : 'status-paid');
            pollInfo.textContent = '';
            showSuccess(username);
          } else if(d.status === 'webhook_pending'){
            // Update challenge_url if it appeared
            if(d.challenge_url){
              pollInfo.innerHTML = 'Click the link below to confirm your order and get an invoice:<br><a href="' + d.challenge_url + '" target="_blank" style="color:#8b5cf6;font-weight:600">' + d.challenge_url + '</a>';
            }
          } else if(d.status === 'pending' && d.bolt11){
            // Transitioned from webhook_pending to pending: show QR and bolt11
            var qrEl = document.getElementById('qrcode');
            qrEl.innerHTML = '';
            if(typeof QRCode !== 'undefined'){
              new QRCode(qrEl, {text: d.bolt11, width:220, height:220, colorDark:'#000', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.L});
            }
            bolt11Box.textContent = d.bolt11;
            bolt11Box.style.display = 'block';
            bolt11Box.onclick = function(){
              navigator.clipboard.writeText(d.bolt11).then(function(){
                var orig = bolt11Box.textContent;
                bolt11Box.textContent = 'Copied!';
                setTimeout(function(){bolt11Box.textContent = orig;}, 1500);
              });
            };
            payBadge.textContent = 'waiting for payment';
            payBadge.className = 'status-badge status-pending';
            pollInfo.textContent = 'Checking payment status...';
          }
        });
    }, 3000);
  }

  function showSuccess(username){
    successBox.style.display = 'block';
    var lines = [username + '@noscha.io'];
    if(document.getElementById('svc-subdomain').checked) lines.push(username+'.noscha.io');
    if(document.getElementById('svc-nip05').checked) lines.push('NIP-05: '+username+'@noscha.io');
    successDetail.innerHTML = lines.join('<br>') + '<br><br>Your services are now active.';

    var mgmtSection = document.getElementById('mgmt-section');
    if(currentManagementToken){
      mgmtSection.style.display = 'block';
      var myPagePath = '/my/' + currentManagementToken;
      var mgmtLinkEl = document.getElementById('mgmt-link');
      mgmtLinkEl.innerHTML = '<a href="' + myPagePath + '">My Page: ' + myPagePath + '</a>';
      document.getElementById('copy-token-btn').onclick = function(){
        navigator.clipboard.writeText(location.origin + myPagePath).then(function(){
          var btn = document.getElementById('copy-token-btn');
          btn.textContent = 'Copied!';
          setTimeout(function(){btn.textContent = 'Copy management token';}, 1500);
        });
      };
    } else {
      mgmtSection.style.display = 'none';
    }
  }

  // Back / cancel
  backBtn.addEventListener('click', function(){
    clearInterval(pollTimer);
    infoSection.style.display = 'block';
    payScreen.style.display = 'none';
    orderBtn.disabled = false;
    orderBtn.textContent = 'Pay with Lightning';
  });

  // Curl copy button
  document.getElementById('curl-copy-btn').addEventListener('click', function(){
    var btn = this;
    navigator.clipboard.writeText('curl -s https://noscha.io/llms.txt').then(function(){
      btn.textContent = 'copied!';
      setTimeout(function(){ btn.textContent = 'copy'; }, 1500);
    });
  });
})();

// Donate QR + copy
(function(){
  new QRCode(document.getElementById('donate-qr'), {
    text: 'lightning:nostarou@coinos.io',
    width: 140, height: 140,
    colorDark: '#000', colorLight: '#fff',
    correctLevel: QRCode.CorrectLevel.M
  });
  document.getElementById('donate-copy-btn').addEventListener('click', function(){
    var btn = this;
    navigator.clipboard.writeText('nostarou@coinos.io').then(function(){
      btn.textContent = 'copied!';
      setTimeout(function(){ btn.textContent = 'copy'; }, 1500);
    });
  });
})();
</script>
<footer style="text-align:center;padding:1rem;color:#444;font-size:0.7rem;font-family:'JetBrains Mono',monospace;">v2026.02.12 · <a href="https://github.com/kojira/noscha-io" target="_blank" rel="noopener" style="color:#444;text-decoration:none;">GitHub</a></footer>
</body>
</html>
